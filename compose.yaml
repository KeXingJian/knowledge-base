services:
  ollama:
    image: ollama/ollama:latest
    container_name: rag-ollama
    restart: unless-stopped
    hostname: ollama
    ports:
      - ${OLLAMA_EXPOSE_PORT}:11434
    volumes:
      - ${OLLAMA_STORE}:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_KEEP_ALIVE=24h
    networks:
      - rag-network
    entrypoint: |
      sh -c "
      echo 'Starting Ollama...'
      ollama serve &
      sleep 5
      echo 'Pulling embedding model...'
      ollama pull nomic-embed-text
      echo 'Pulling chat model...'
      ollama pull qwen2:7b
      echo 'Models ready!'
      tail -f /dev/null
      "

  postgres:
    image: pgvector/pgvector:pg16
    container_name: rag-postgres
    restart: unless-stopped
    hostname: postgres
    ports:
      - ${DATABASE_EXPOSE_PORT}:5432
    environment:
      - POSTGRES_DB=${DATABASE_DB}
      - POSTGRES_USER=${DATABASE_USER}
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
    volumes:
      - ${DATABASE_STORE}:/var/lib/postgresql/data
    networks:
      - rag-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DATABASE_USER} -d ${DATABASE_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5
  redis:
    image: 'redis:7-alpine'
    container_name: redis
    hostname: redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - ${REDIS_EXPOSE_PORT}:6379
    volumes:
      - ${REDIS_STORE}:/data
    restart: always
    networks:
      - rag-network

  # MinIO - 对象存储服务
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    hostname: minio
    ports:
      - ${MINIO_EXPOSE_PORT}:9000
      - ${MINIO_CONSOLE_PORT}:9001
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    volumes:
      - ${MINIO_STORE}:/data
    command: server /data --console-address ":9001"
    networks:
      - rag-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  web:
    build:
      context: .
      dockerfile: ./Dockerfile
      extra_hosts:
        - host.docker.internal:host-gateway
    container_name: web
    hostname: web
    environment:
      LOG_PATH: ${LOG_PATH}
      WEB_EXPOSE_PORT: ${WEB_EXPOSE_PORT}

      DATABASE_DB: ${DATABASE_DB}
      DATABASE_HOST_PORT: ${DATABASE_HOST_PORT}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}

      DATABASE_DEFAULT_SCHEMA: ${DATABASE_DEFAULT_SCHEMA}

      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL}
      OLLAMA_CHAT_TIMEOUT: ${OLLAMA_CHAT_TIMEOUT}
      OLLAMA_EMBEDDING_TIMEOUT: ${OLLAMA_EMBEDDING_TIMEOUT}

      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PUBLIC_ENDPOINT: ${MINIO_PUBLIC_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME}
      MINIO_SECURE: ${MINIO_SECURE}

      DOCUMENT_CHUNK_SIZE: ${DOCUMENT_CHUNK_SIZE}
      DOCUMENT_BATCH_SIZE: ${DOCUMENT_BATCH_SIZE}
      DOCUMENT_ENABLE_PARALLEL: ${DOCUMENT_ENABLE_PARALLEL}

      RETRIEVAL_TOP_K: ${RETRIEVAL_TOP_K}
      RETRIEVAL_VECTOR_WEIGHT: ${RETRIEVAL_VECTOR_WEIGHT}
      RETRIEVAL_TEXT_WEIGHT: ${RETRIEVAL_TEXT_WEIGHT}
      RETRIEVAL_ENABLE_FULLTEXT: ${RETRIEVAL_ENABLE_FULLTEXT}
      RETRIEVAL_FALLBACK_KEYWORD: ${RETRIEVAL_FALLBACK_KEYWORD}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      ollama:
        condition: service_started
      minio:
        condition: service_healthy
    ports:
      - ${WEB_EXPOSE_PORT}:8080
    extra_hosts:
      - host.docker.internal:host-gateway
    volumes:
      - ${LOG_PATH}:/var/log
    networks:
      - rag-network

  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    hostname: nginx
    ports:
      - ${NGINX_EXPOSE_PORT}:80
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ui:/usr/share/nginx/html:ro
    depends_on:
      - web
    networks:
      - rag-network

# 网络配置
networks:
  rag-network:
    driver: bridge